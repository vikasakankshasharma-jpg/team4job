rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        "Admin" in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }

    function isSupport() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        ("Support Team" in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles || isAdmin());
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---


    // Confidential User Data (PII)
    match /users/{userId} {
      // PRODUCTION: Restrict user data access to authorized parties only
      // Owner can read their own data, Admins and Support can read all
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdmin() || isSupport());
      
      // Strict Update Policy: Prevent Privilege Escalation
      // Users can ONLY update specific profile fields. 
      // THEY CANNOT UPDATE: roles, status, subscription, kycStatus, installerProfile.verified, etc.
      allow update: if isOwner(userId) && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(
          ['name', 'avatarUrl', 'address', 'pincodes', 'about', 'portfolio', 'installerProfile', 'fcmTokens', 'lastLoginAt', 'lastActiveAt', 'emergencyContacts']
        ) &&
        // If updating installerProfile, ensure they aren't verifying themselves or changing ratings
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['installerProfile']) || 
         (request.resource.data.installerProfile.diff(resource.data.installerProfile).affectedKeys().hasOnly(['skills', 'about']) || 
          isAdmin())
        );
        
      // Allow Admin to write anything
      allow write: if isAdmin();
      
      // --- SUBCOLLECTIONS ---
      
      // Job Drafts (e.g. users/123/jobDrafts/draft_456)
      match /jobDrafts/{draftId} {
        allow read, write: if isOwner(userId);
      }
      
      // Job Templates (Full Job)
      match /jobTemplates/{templateId} {
        allow read, write: if isOwner(userId);
      }
      
      // Budget Templates (Price Ranges)
      match /budgetTemplates/{templateId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Public Profiles - Visible to everyone
    match /public_profiles/{userId} {
      allow read: if true;
      allow write: if false; // Only via Cloud Functions or Admin SDK
    }
    
    // Jobs - Core Logic Security
    match /jobs/{jobId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        "Job Giver" in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles &&
        request.resource.data.jobGiverId == request.auth.uid;
      
      allow update: if request.auth != null && 
        (resource.data.jobGiverId == request.auth.uid || 
         resource.data.installerId == request.auth.uid ||
         (resource.data.awardedInstaller != null && resource.data.awardedInstaller == /databases/$(database)/documents/users/$(request.auth.uid)) ||
         isAdmin() || 
         isSupport());
      
      allow delete: if request.auth != null && 
        (resource.data.jobGiverId == request.auth.uid || isAdmin());

      // --- BIDS SUB-COLLECTION ---
      match /bids/{bidId} {
        allow read: if true;
        
        allow create: if request.auth != null && 
          "Installer" in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles &&
          request.resource.data.installerId == request.auth.uid &&
          get(/databases/$(database)/documents/jobs/$(jobId)).data.jobGiverId != request.auth.uid;
          
        allow update, delete: if isOwner(resource.data.installerId) || isAdmin();
      }
      
      // --- COMMUNICATIONS SUB-COLLECTION (Phase 11 Enhancement #7) ---
      match /communications/{commId} {
        // Helper to check if user is job participant
        function isJobParticipant() {
          let jobData = get(/databases/$(database)/documents/jobs/$(jobId)).data;
          return request.auth.uid == jobData.jobGiverId ||
                 request.auth.uid == jobData.awardedInstaller ||
                 (jobData.awardedInstaller != null && 
                  jobData.awardedInstaller == /databases/$(database)/documents/users/$(request.auth.uid));
        }
        
        // Job participants can read all communications
        allow read: if request.auth != null && isJobParticipant();
        
        // Job participants can create communications
        allow create: if request.auth != null && 
          isJobParticipant() &&
          request.resource.data.author == request.auth.uid &&
          request.resource.data.jobId == jobId;
        
        // Only admins can update/delete (or author within 5 minutes - future enhancement)
        allow update, delete: if isAdmin();
      }
    }


    

    
    // Transactions - Production Rules
    match /transactions/{transactionId} {
      allow read: if request.auth != null && 
        (resource.data.payerId == request.auth.uid || 
         resource.data.payeeId == request.auth.uid || 
         isAdmin() || 
         isSupport());
      
      // Allow creation only if user is the payer
      allow create: if request.auth != null && 
        request.resource.data.payerId == request.auth.uid;
        
      // Allow updates only by payer or admin (and restricted fields if needed)
      allow update: if request.auth != null && 
        (resource.data.payerId == request.auth.uid || isAdmin());
        
      allow delete: if isAdmin();
    }

    // Disputes
    match /disputes/{disputeId} {
      allow read: if request.auth != null && 
        (resource.data.requesterId == request.auth.uid ||
         resource.data.parties.jobGiverId == request.auth.uid || 
         resource.data.parties.installerId == request.auth.uid || 
         isSupport());
      allow create: if request.auth != null && request.resource.data.requesterId == request.auth.uid;
      allow update: if request.auth != null && (resource.data.requesterId == request.auth.uid || isSupport());
    }

    // Blacklist - Admin Only
    match /blacklist/{entry} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Subscription Plans - Admin Write, Public Read
    match /subscriptionPlans/{planId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    // Platform Settings - Admin Write, Public Read
    match /platform_settings/{setting} {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    // Coupons - Admin Only
    match /coupons/{couponId} {
      allow read: if request.auth != null; // Users can read to validate coupons
      allow write: if isAdmin();
    }
    
    // Admin Alerts - Admin Only
    match /admin_alerts/{alertId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions/Admin SDK
    }
    
    // Admin Action Logs - Admin Read, System Write
    match /admin_action_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions/Admin SDK
    }
    
    // Pending Signups - Admin Read/Write, System Write
    match /pending_signups/{mobile} {
      allow read: if isAdmin() || isSupport();
      allow create: if request.auth == null; // Allow creation during signup (before auth)
      allow update: if request.auth == null || isAdmin() || isSupport(); // Allow updates during signup or by admin
      allow delete: if isAdmin();
    }
    
    // Settings (not platform_settings) - readable by all authenticated users
    match /settings/{settingId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }


    // --- ACTIVITIES ---
    // User Activities - Readable by owner, Writable by owner (for client-side logging) or Admin
    match /activities/{activityId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null; // Allow creation by any auth user (e.g. for notifications or cross-user events)
      allow update, delete: if isAdmin();
    }

    // --- NOTIFICATIONS ---
    
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // Allow creation by any authenticated user (needed for invites/chats)
      allow create: if request.auth != null;
      
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdmin());

      allow delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdmin());
    }

    match /notificationPreferences/{userId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      
      allow write: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
    }
  }
}
