
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['Admin']);
    }
    
    function isJobGiver(userId) {
       return get(/databases/$(database)/documents/users/$(userId)).data.roles.hasAny(['Job Giver']);
    }
    
    function isInstaller(userId) {
       return get(/databases/$(database)/documents/users/$(userId)).data.roles.hasAny(['Installer']);
    }
    
    // By default, deny all access.
    match /{document=**} {
      allow read, write: if false;
    }

    // USERS
    match /users/{userId} {
      // Any authenticated user can read any other user's public profile
      allow get: if isSignedIn();
      // Only admins can list all users
      allow list: if isAdmin();
      // A user can create their own profile
      allow create: if isOwner(userId);
      // A user can update their own profile. Admins can also update any profile.
      allow update: if isOwner(userId) || isAdmin();
       // Only an admin can delete a user (after they are deactivated)
      allow delete: if isAdmin();
    }
    
    // JOBS
    match /jobs/{jobId} {
        // Any authenticated user can view a job
        allow get: if isSignedIn();
        // Only installers and job givers can see the list of jobs
        allow list: if isInstaller(request.auth.uid) || isJobGiver(request.auth.uid) || isAdmin();
        // Only a Job Giver can create a job
        allow create: if isJobGiver(request.auth.uid);
        // Only the Job Giver who posted the job or an Admin can update it.
        // Installers can also update to accept a job.
        allow update: if isSignedIn() && (
                        resource.data.jobGiver == /databases/$(database)/documents/users/$(request.auth.uid) 
                        || isAdmin() 
                        || request.auth.uid == resource.data.awardedInstaller.id
                      );
        // Only the job giver or an admin can delete a job
        allow delete: if isSignedIn() && (resource.data.jobGiver == /databases/$(database)/documents/users/$(request.auth.uid) || isAdmin());
    }

    // DISPUTES
    match /disputes/{disputeId} {
        // Only involved parties or admins can read a dispute
        allow get: if isSignedIn() && (
                     request.auth.uid == resource.data.requesterId
                     || (resource.data.parties != null && (request.auth.uid == resource.data.parties.jobGiverId || request.auth.uid == resource.data.parties.installerId))
                     || isAdmin()
                   );
        // Users can list their own disputes. Admins can list all.
        allow list: if isSignedIn();
        // Any authenticated user can create a dispute
        allow create: if isSignedIn();
        // Only involved parties or admins can update (add messages to) a dispute
        allow update: if isSignedIn() && (
                        request.auth.uid == resource.data.requesterId
                        || (resource.data.parties != null && (request.auth.uid == resource.data.parties.jobGiverId || request.auth.uid == resource.data.parties.installerId))
                        || isAdmin()
                      );
    }
    
    // COUPONS, BLACKLIST, TRANSACTIONS, PLANS
    // These collections should be admin-only
    match /coupons/{couponId} {
      allow read, write: if isAdmin();
    }

    match /blacklist/{blacklistId} {
      allow read, write: if isAdmin();
    }

    match /transactions/{transactionId} {
      allow read, write: if isAdmin();
    }

    match /subscriptionPlans/{planId} {
      allow read, write: if isAdmin();
    }
  }
}
