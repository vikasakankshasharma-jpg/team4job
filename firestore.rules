
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and reuse logic.
    function isSignedIn() {
      return request.auth != null;
    }

    // Is the requesting user the owner of the document?
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Get the requesting user's data from the 'users' collection.
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if the user has the 'Admin' role.
    function isAdmin() {
      return isSignedIn() && 'Admin' in getUserData().roles;
    }

    // --- Collection: users ---
    // Rules for the user profiles.
    match /users/{userId} {
      // Any signed-in user can read or list user profiles.
      allow read, list: if isSignedIn();
      // A user can only create their own profile.
      allow create: if isOwner(userId);
      // A user can update their own profile, or an admin can update any profile.
      allow update: if isOwner(userId) || isAdmin();
      // Only an admin can delete a user profile.
      allow delete: if isAdmin();
    }

    // --- Collection: jobs ---
    // Rules for job postings.
    match /jobs/{jobId} {
      // Any signed-in user can read or list jobs. This is required for browsing jobs.
      allow read, list: if isSignedIn();
      // Any signed-in user (typically a 'Job Giver') can create a job.
      allow create: if isSignedIn();
      // A job can be updated by its creator ('Job Giver') or an admin.
      // Note: We check the incoming resource's jobGiver field. This is less secure
      // as a user could potentially change the jobGiver. A better approach is to
      // compare with the existing resource.data.jobGiver, but that prevents
      // updates on documents that don't exist yet (like in a transaction).
      allow update: if isSignedIn() && (request.resource.data.jobGiver == request.auth.uid || isAdmin());
      // Only admins can delete jobs.
      allow delete: if isAdmin();
    }

    // --- Collection: disputes ---
    // Rules for dispute tickets.
    match /disputes/{disputeId} {
      // A user can read/update a dispute if they are the requester, a party involved, or an admin.
      allow read, update: if isSignedIn() && (
        resource.data.requesterId == request.auth.uid ||
        (resource.data.parties != null && (
          resource.data.parties.jobGiverId == request.auth.uid ||
          resource.data.parties.installerId == request.auth.uid
        )) ||
        isAdmin()
      );
      // Any signed-in user can create a dispute.
      allow create: if isSignedIn();
      // Only admins can delete disputes.
      allow delete: if isAdmin();
      
      // IMPORTANT: `list` rules are for queries. They do NOT combine with `read`.
      // The frontend must perform separate queries that match these conditions exactly.
      allow list: if isSignedIn() && (
        // Allow a user to query for disputes they requested.
        (request.query.where.requesterId == request.auth.uid) ||
        // Allow a user to query for disputes where they are the job giver.
        (request.query.where['parties.jobGiverId'] == request.auth.uid) ||
         // Allow a user to query for disputes where they are the installer.
        (request.query.where['parties.installerId'] == request.auth.uid) ||
        // Admins can list all disputes.
        isAdmin()
      );
    }
    
    // --- Admin-only Collections ---

    match /blacklist/{blacklistId} {
      allow read, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /coupons/{couponId} {
      allow read, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /subscriptionPlans/{planId} {
      allow read, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /transactions/{transactionId} {
      allow read, list: if isSignedIn();
      // Transactions are system-generated, no client writes.
      allow write: if false; 
    }
  }
}
