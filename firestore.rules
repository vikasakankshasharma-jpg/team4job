rules_version = '2';

// In these rules, `request.auth` is an object containing the user's
// authentication information, or `null` if the user is not authenticated.
// `request.auth.uid` is the user's unique ID.
// `request.auth.token.roles` is a custom claim set during user creation.

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.token.roles.hasAny(['Admin']);
    }

    // Collection: users
    // Manages user profile data.
    match /users/{userId} {
      // READ: Any authenticated user can read any profile (for viewing job givers, installers).
      allow list, read: if isSignedIn();

      // CREATE: A user can only create their own profile.
      allow create: if isOwner(userId);
      
      // UPDATE: A user can only update their own profile, or an admin can update any.
      allow update: if isOwner(userId) || isAdmin();
    }

    // Collection: jobs
    // Manages job postings, bids, and communication.
    match /jobs/{jobId} {
      // READ: Any authenticated user can read and list jobs.
      allow list, read: if isSignedIn();

      // CREATE: Any authenticated user can create a job.
      allow create: if isSignedIn();

      // UPDATE: Only the job giver or an admin can update a job.
      // We check the *existing* resource to find the original job giver.
      allow update: if isSignedIn() && (resource.data.jobGiver.id == request.auth.uid || isAdmin());
    }

    // Collection: disputes
    // Manages conflict resolution between users.
    match /disputes/{disputeId} {
      // READ/LIST: Only participants (requester, parties) or an Admin can read.
      allow list, read: if isSignedIn() && 
                            (request.auth.uid == resource.data.requesterId ||
                             request.auth.uid == resource.data.parties.jobGiverId ||
                             request.auth.uid == resource.data.parties.installerId ||
                             isAdmin());
      
      // CREATE: Any authenticated user can create a dispute.
      allow create: if isSignedIn();

      // UPDATE: Only participants or an admin can update (e.g., add messages).
      allow update: if isSignedIn() &&
                      (request.auth.uid == resource.data.requesterId ||
                       request.auth.uid == resource.data.parties.jobGiverId ||
                       request.auth.uid == resource.data.parties.installerId ||
                       isAdmin());
    }

    // Collection: blacklist
    // Admin-only collection for blocking users/pincodes.
    match /blacklist/{entry} {
       // READ: Any authenticated user needs to be able to check this on login.
      allow read, list: if isSignedIn();

      // WRITE: Only Admins can create, update, or delete blacklist entries.
      allow write: if isAdmin();
    }

    // Collections: coupons, subscriptionPlans
    // These are admin-managed collections.
    match /coupons/{couponId} {
      allow read, write: if isAdmin();
    }
    match /subscriptionPlans/{planId} {
       allow read, write: if isAdmin();
    }
     match /transactions/{transactionId} {
       allow read, write: if isAdmin();
    }
  }
}
    