rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles[0] == 'Admin';
    }

    // Users can read/update their own profile, anyone can create (signup).
    // Listing users is allowed for any authenticated user to fetch related data for jobs/bids.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == userId || isAdmin();
      allow list: if request.auth != null; // Allow listing for all authenticated users.
      allow delete: if isAdmin();
    }

    // Jobs can be read/listed by anyone authenticated.
    // Creation is allowed for authenticated users.
    // Updates are restricted to the job giver, awarded installer, or an admin.
    match /jobs/{jobId} {
      allow read, list: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.jobGiver.id 
                    || request.auth.uid == resource.data.awardedInstaller.id
                    || isAdmin();
    }
    
    // Admins have full access to disputes, coupons, and blacklist.
    // Users involved in a dispute can also read/update it.
    match /disputes/{disputeId} {
        allow read, update: if request.auth.uid == resource.data.requesterId
                        || request.auth.uid == resource.data.parties.jobGiverId
                        || request.auth.uid == resource.data.parties.installerId
                        || isAdmin();
        allow list, create, delete: if isAdmin();
    }

    match /coupons/{couponId} {
        allow read, list, create, update, delete: if isAdmin();
    }

    match /blacklist/{blacklistId} {
        allow read, list, create, update, delete: if isAdmin();
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
