
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    function isAdmin() {
      return 'Admin' in getUserRole();
    }
    
    function isJobGiver() {
      return 'Job Giver' in getUserRole();
    }
    
    // --- Collection Rules ---

    // /users/{userId}
    match /users/{userId} {
      // ANY authenticated user can read any other user's profile.
      // This is necessary for Job Givers to see Installer profiles, etc.
      allow read: if isSignedIn();
      
      // A user can only create their own profile document.
      allow create: if isUser(userId);
      
      // A user can only update their own profile.
      allow update: if isUser(userId);
      
      // Only an admin can delete a user document.
      allow delete: if isAdmin();
    }

    // /jobs/{jobId}
    match /jobs/{jobId} {
      // ANY authenticated user can read or list jobs.
      allow read, list: if isSignedIn();
      
      // Any authenticated user can create a job.
      allow create: if isSignedIn();
      
      // A job can be updated only by its original Job Giver or an Admin.
      allow update: if (resource.data.jobGiver == request.auth.uid || isAdmin());
      
      // Only an Admin can delete a job.
      allow delete: if isAdmin();
    }

    // /disputes/{disputeId}
    match /disputes/{disputeId} {
       // A user can create a dispute.
      allow create: if isSignedIn();
      
      // A user can read/update a dispute if they are the requester, a party to it, or an admin.
      allow read, update: if isSignedIn() && (request.auth.uid == resource.data.requesterId || request.auth.uid in resource.data.parties || isAdmin());
      
      // Only an admin can delete a dispute.
      allow delete: if isAdmin();
    }

    // /blacklist/{blacklistId}
    match /blacklist/{blacklistId} {
        // Any authenticated user can check the blacklist (needed for login security check).
        allow read: if isSignedIn();
        // Only admins can write to the blacklist.
        allow write: if isAdmin();
    }
    
    // /coupons/{couponCode}
    match /coupons/{couponCode} {
        // Any authenticated user can read coupon info (e.g., to validate a code).
        allow read: if isSignedIn();
        // Only admins can create/update/delete coupons.
        allow write: if isAdmin();
    }

    // /subscriptionPlans/{planId}
    match /subscriptionPlans/{planId} {
        // Any authenticated user can read subscription plans.
        allow read: if isSignedIn();
        // Only admins can modify plans.
        allow write: if isAdmin();
    }

    // /transactions/{transactionId}
    match /transactions/{transactionId} {
        // A user can read a transaction if they are the payer or payee, or an admin.
        allow read: if isSignedIn() && (request.auth.uid == resource.data.payerId || request.auth.uid == resource.data.payeeId || isAdmin());
        
        // Writes should be handled by a secure backend function.
        allow write: if false;
    }
  }
}

    