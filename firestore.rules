rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles[0] == 'Admin';
    }

    // Default Deny: Disallow all reads and writes by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Users Collection
    match /users/{userId} {
      // Anyone can check for user existence for signup validation
      allow list: if isAuthenticated();
      // Any authenticated user can view any profile
      allow read: if isAuthenticated();
      // A user can only create their own profile
      allow create: if isOwner(userId);
      // A user can only update their own profile
      allow update: if isOwner(userId) || isAdmin();
    }
    
    // Jobs Collection
    match /jobs/{jobId} {
      // Anyone authenticated can read and list jobs
      allow read, list: if isAuthenticated();
      // Any authenticated user can create a job
      allow create: if isAuthenticated();
      // Only the job giver or an admin can update a job
      allow update: if isAuthenticated() && (resource.data.jobGiver == request.auth.uid || isAdmin());
    }
    
    // Disputes Collection
    match /disputes/{disputeId} {
       // Only participants or an Admin can read.
       allow read, list: if isAuthenticated() && 
                          (request.auth.uid == resource.data.requesterId ||
                           request.auth.uid == resource.data.parties.jobGiverId ||
                           request.auth.uid == resource.data.parties.installerId ||
                           isAdmin());
       // Any authenticated user can create a dispute
       allow create: if isAuthenticated();
       // Only participants or an admin can update a dispute by adding messages
       allow update: if isAuthenticated() &&
                          (request.auth.uid == resource.data.requesterId ||
                           request.auth.uid == resource.data.parties.jobGiverId ||
                           request.auth.uid == resource.data.parties.installerId ||
                           isAdmin());
    }
    
    // Blacklist Collection
    match /blacklist/{blacklistId} {
      // Any authenticated user can check the blacklist
      allow read, list: if isAuthenticated();
      // Only admins can write to the blacklist
      allow write: if isAdmin();
    }

    // Coupons Collection
    match /coupons/{couponId} {
        // Any authenticated user can check for coupons
        allow read, list: if isAuthenticated();
        // Only admins can create/update/delete coupons
        allow write: if isAdmin();
    }

    // All other collections are admin-only by default from the top-level rule
    // for collections like `subscriptionPlans` or `transactions` if needed.
  }
}
